const sigCanvas=document.getElementById("signature"),sigCtx=sigCanvas.getContext("2d");let drawing=!1,lastX=0,lastY=0;function startDraw(t){t.touches&&t.preventDefault(),drawing=!0,[lastX,lastY]=getXY(t)}function draw(t){if(!drawing)return;t.touches&&t.preventDefault();const[e,o]=getXY(t);sigCtx.lineWidth=2,sigCtx.lineCap="round",sigCtx.strokeStyle="#222",sigCtx.beginPath(),sigCtx.moveTo(lastX,lastY),sigCtx.lineTo(e,o),sigCtx.stroke(),[lastX,lastY]=[e,o]}function endDraw(t){t&&t.touches&&t.preventDefault(),drawing=!1}function getXY(t){const e=sigCanvas.getBoundingClientRect();return t.touches?[t.touches[0].clientX-e.left,t.touches[0].clientY-e.top]:[t.offsetX,t.offsetY]}sigCanvas.addEventListener("mousedown",startDraw),sigCanvas.addEventListener("mousemove",draw),sigCanvas.addEventListener("mouseup",endDraw),sigCanvas.addEventListener("mouseleave",endDraw),sigCanvas.addEventListener("touchstart",startDraw,{passive:!1}),sigCanvas.addEventListener("touchmove",draw,{passive:!1}),sigCanvas.addEventListener("touchend",endDraw,{passive:!1}),document.getElementById("clearSig").onclick=function(t){t.preventDefault(),sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height)};let uploadedPhoto=null,croppedPhoto=null;const photoInput=document.getElementById("photoInput"),photoCropSection=document.getElementById("photoCropSection"),cropCanvas=document.getElementById("cropCanvas"),cropCtx=cropCanvas.getContext("2d"),confirmCropBtn=document.getElementById("confirmCrop"),photoPreview=document.getElementById("photoPreview");photoInput.addEventListener("change",function(t){const e=t.target.files[0];if(!e)return;const o=new FileReader;o.onload=function(t){const e=new Image;e.onload=function(){uploadedPhoto=e,cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height);let t=Math.max(cropCanvas.width/e.width,cropCanvas.height/e.height),o=e.width*t,a=e.height*t,n=(cropCanvas.width-o)/2,r=(cropCanvas.height-a)/2;cropCtx.drawImage(e,n,r,o,a),photoCropSection.style.display="flex",photoPreview.style.display="none",croppedPhoto=null},e.src=t.target.result},o.readAsDataURL(e)});let cropStart=null,cropRect=null;function getCropXY(t){const e=cropCanvas.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]}cropCanvas.addEventListener("mousedown",function(t){cropStart=getCropXY(t),cropRect=null}),cropCanvas.addEventListener("mousemove",function(t){if(!cropStart)return;const[e,o]=getCropXY(t);let a=e-cropStart[0],n=o-cropStart[1],r=Math.min(Math.abs(a),Math.abs(n)),i=a<0?cropStart[0]-r:cropStart[0],l=n<0?cropStart[1]-r:cropStart[1];if(cropRect={x:i,y:l,w:r,h:r},cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height),uploadedPhoto){let t=Math.max(cropCanvas.width/uploadedPhoto.width,cropCanvas.height/uploadedPhoto.height),e=uploadedPhoto.width*t,o=uploadedPhoto.height*t,a=(cropCanvas.width-e)/2,n=(cropCanvas.height-o)/2;cropCtx.drawImage(uploadedPhoto,a,n,e,o)}cropRect&&(cropCtx.strokeStyle="#007b3a",cropCtx.lineWidth=1,cropCtx.strokeRect(cropRect.x,cropRect.y,cropRect.w,cropRect.h))}),cropCanvas.addEventListener("mouseup",function(t){if(!cropRect||!uploadedPhoto)return void(cropStart=null);let e=Math.round(cropRect.x),o=Math.round(cropRect.y),a=Math.round(cropRect.w),n=Math.round(cropRect.h);if(a>0&&n>0&&Number.isFinite(e)&&Number.isFinite(o)&&Number.isFinite(a)&&Number.isFinite(n)){const t=cropCtx.getImageData(e,o,a,n),r=document.createElement("canvas");r.width=a,r.height=n,r.getContext("2d").putImageData(t,0,0),croppedPhoto=new Image,croppedPhoto.onload=function(){photoPreview.src=croppedPhoto.src,photoPreview.style.display="block"},croppedPhoto.src=r.toDataURL(),document.getElementById("photoCropSection").style.display="none"}cropStart=null}),confirmCropBtn.addEventListener("click",function(){croppedPhoto?(photoCropSection.style.display="none",photoPreview.style.display="block"):alert("Please select and crop your photo.")}),cropCanvas.addEventListener("touchstart",function(t){t.preventDefault(),cropStart=getCropXY(t),cropRect=null},{passive:!1}),cropCanvas.addEventListener("touchmove",function(t){if(!cropStart)return;t.preventDefault();const[e,o]=getCropXY(t);let a=e-cropStart[0],n=o-cropStart[1],r=Math.min(Math.abs(a),Math.abs(n)),i=a<0?cropStart[0]-r:cropStart[0],l=n<0?cropStart[1]-r:cropStart[1];if(cropRect={x:i,y:l,w:r,h:r},cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height),uploadedPhoto){let t=Math.max(cropCanvas.width/uploadedPhoto.width,cropCanvas.height/uploadedPhoto.height),e=uploadedPhoto.width*t,o=uploadedPhoto.height*t,a=(cropCanvas.width-e)/2,n=(cropCanvas.height-o)/2;cropCtx.drawImage(uploadedPhoto,a,n,e,o)}cropRect&&(cropCtx.strokeStyle="#007b3a",cropCtx.lineWidth=.3,cropCtx.strokeRect(cropRect.x,cropRect.y,cropRect.w,cropRect.h))},{passive:!1}),cropCanvas.addEventListener("touchend",function(t){if(!cropRect||!uploadedPhoto)return void(cropStart=null);let e=Math.round(cropRect.x),o=Math.round(cropRect.y),a=Math.round(cropRect.w),n=Math.round(cropRect.h);if(a>0&&n>0&&Number.isFinite(e)&&Number.isFinite(o)&&Number.isFinite(a)&&Number.isFinite(n)){const t=cropCtx.getImageData(e,o,a,n),r=document.createElement("canvas");r.width=a,r.height=n,r.getContext("2d").putImageData(t,0,0),croppedPhoto=new Image,croppedPhoto.onload=function(){photoPreview.src=croppedPhoto.src,photoPreview.style.display="block"},croppedPhoto.src=r.toDataURL(),document.getElementById("photoCropSection").style.display="none"}cropStart=null},{passive:!1});const form=document.getElementById("idForm"),cardPreview=document.getElementById("cardPreview"),idCardCanvas=document.getElementById("idCardCanvas"),downloadBtn=document.getElementById("downloadBtn");function updateIDCardHtml(t){document.getElementById("serialNumberHtml").textContent=t.serialNumber,document.getElementById("idNumberHtml").textContent=t.idNumber,document.getElementById("fullNameHtml").textContent=t.name.toUpperCase(),document.getElementById("dobHtml").textContent=formatDate(t.dob),document.getElementById("sexHtml").textContent=t.sex.toUpperCase(),document.getElementById("districtHtml").textContent=t.district.toUpperCase(),document.getElementById("placeHtml").textContent=t.place.toUpperCase(),document.getElementById("issueDateHtml").textContent=formatDate(t.dateOfIssue),t.photo&&(document.getElementById("photoHtml").src=t.photo.src||t.photo),t.signature&&(document.getElementById("signatureHtml").src=t.signature.toDataURL?t.signature.toDataURL():t.signature)}function randomDigits(t){let e="";for(let o=0;o<t;o++)e+=Math.floor(10*Math.random());return e}function isCanvasBlank(t){const e=t.getContext("2d");return!new Uint32Array(e.getImageData(0,0,t.width,t.height).data.buffer).some(t=>0!==t)}function drawIDCard(t){const e=idCardCanvas.getContext("2d");e.clearRect(0,0,idCardCanvas.width,idCardCanvas.height),e.fillStyle="#fff",e.fillRect(0,0,idCardCanvas.width,idCardCanvas.height),e.font="bold 32px Arial",e.fillStyle="#217346",e.textAlign="left",e.fillText("JAMHURI YA KENYA",40,60),e.textAlign="right",e.fillText("REPUBLIC OF KENYA",640,60);const o=document.getElementById("coatArmsImg");e.drawImage(o,295,70,90,60);const a=document.getElementById("shieldImg");e.drawImage(a,325,135,40,60),e.font="bold 15px Arial",e.fillStyle="#222",e.textAlign="left",e.fillText("SERIAL NUMBER:",40,160),e.font="bold 22px Arial",e.fillText(t.serialNumber,180,160),e.font="bold 15px Arial",e.textAlign="right",e.fillText("ID NUMBER:",640,160),e.font="bold 22px Arial",e.fillText(t.idNumber,770,160),e.font="bold 13px Arial",e.textAlign="left",e.fillText("FULL NAMES",40,200),e.font="bold 22px Arial",e.fillText(t.name.toUpperCase(),40,230);const n=245,r=230;t.photo&&(e.save(),e.beginPath(),e.rect(40,n,200,r),e.closePath(),e.clip(),e.drawImage(t.photo,40,n,200,r),e.restore()),e.font="bold 13px Arial",e.fillStyle="#222",e.fillText("HOLDER'S SIGN.",40,505),e.drawImage(t.signature,150,485,90,30);let i=270,l=245,d=520;e.font="bold 13px Arial",e.fillStyle="#222",e.textAlign="left",e.fillText("DATE OF BIRTH",i,l),e.font="20px Arial",e.fillText(formatDate(t.dob),d,l),e.font="bold 13px Arial",e.fillText("SEX",i,280),e.font="20px Arial",e.fillText(t.sex.toUpperCase(),d,280),e.font="bold 13px Arial",e.fillText("DISTRICT OF BIRTH",i,315),e.font="20px Arial",e.fillText(t.district.toUpperCase(),d,315),e.font="bold 13px Arial",e.fillText("PLACE OF ISSUE",i,350),e.font="20px Arial",e.fillText(t.place.toUpperCase(),d,350),e.font="bold 13px Arial",e.fillText("DATE OF ISSUE",i,385),e.font="20px Arial",e.fillText(formatDate(t.dateOfIssue),d,385);const c=document.getElementById("fingerprintImg");e.drawImage(c,600,340,140,120),e.textAlign="left"}function formatDate(t){const e=new Date(t);return`${String(e.getDate()).padStart(2,"0")}. ${String(e.getMonth()+1).padStart(2,"0")}. ${e.getFullYear()}`}form.onsubmit=function(t){t.preventDefault();const e=document.getElementById("fullName").value.trim(),o=document.getElementById("dob").value,a=document.getElementById("sex").value,n=document.getElementById("district").value.trim(),r=document.getElementById("place").value.trim();if(!(e&&o&&a&&n&&r))return void alert("Please fill all fields.");if(!croppedPhoto&&uploadedPhoto){let t=uploadedPhoto,e=Math.min(t.width,t.height),o=Math.floor((t.width-e)/2),a=Math.floor((t.height-e)/2),n=document.createElement("canvas");n.width=e,n.height=e,n.getContext("2d").drawImage(t,o,a,e,e,0,0,e,e),croppedPhoto=new Image,croppedPhoto.src=n.toDataURL("image/png")}if(!croppedPhoto)return void alert("Please upload and crop your photo.");if(e.length>30)return void alert("Full Name must be at most 30 letters.");if(n.length>15)return void alert("District of Birth must be at most 15 letters.");if(r.length>15)return void alert("Place of Issue must be at most 15 letters.");const i=new Date(o),l=new Date,d=l.getFullYear()-i.getFullYear()-(l<new Date(l.getFullYear(),i.getMonth(),i.getDate())?1:0);if(d<18)return void alert("User must be at least 18 years old.");if(d>120)return void alert("Age cannot be greater than 120 years.");if(isCanvasBlank(sigCanvas))return void alert("Please draw your signature.");const c=l.toISOString().slice(0,10),s=randomDigits(8),p=randomDigits(9);let u=document.createElement("canvas");u.width=sigCanvas.width,u.height=sigCanvas.height,u.getContext("2d").drawImage(sigCanvas,0,0),updateIDCardHtml({name:e,dob:o,sex:a,district:n,place:r,dateOfIssue:c,idNumber:s,serialNumber:p,signature:u,photo:croppedPhoto}),cardPreview.style.display="block"},downloadBtn.onclick=function(){const t=document.getElementById("idCardHtml"),e=t.querySelectorAll("img"),o=Array.from(e).map(t=>t.complete&&0!==t.naturalHeight?Promise.resolve():new Promise(e=>{t.onload=t.onerror=e}));Promise.all(o).then(()=>{html2canvas(t,{backgroundColor:null,scale:2}).then(function(t){const e=document.createElement("a");e.download="kenya_id_card.png",e.href=t.toDataURL("image/png"),e.click()})})};